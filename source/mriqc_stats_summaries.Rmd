---
title: "R Notebook"
output: html_document
always_allow_html: yes
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*.

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


```{r}
library(tidyverse)
library(grid)
library(gridExtra)
```


Some plotting functions

```{r}
plot_mriqc_metric <- function(mriqc,metric,title){
  
 plot <- ggplot(data=mriqc, mapping = aes_string(x="subj", y=metric)) + geom_boxplot(outlier.shape=NA, width=0.75, colour="gray82") + geom_jitter(width=0.3, aes( fill=site, shape=site), size=3)+theme_classic(base_size=10)+theme(panel.background = element_rect(fill="white", colour="white"),axis.title.x=element_blank(),axis.title.y = element_text())+labs(y=title) +scale_shape_manual(values=shapez)+scale_fill_manual(values=fillz) +guides(fill=guide_legend("scanner"), shape=guide_legend("scanner"))
  
  return(plot)

}


grid_arrange_shared_legend <- function(...) {
    plots <- list(...)
    g <- ggplotGrob(plots[[1]] + theme(legend.position="bottom"))$grobs
    legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
    lheight <- sum(legend$height)
    
  grid.arrange(arrangeGrob(grobs=lapply(plots, function(x)
      x + theme(legend.position="none",aspect.ratio=0.6))),
    legend,
    ncol = 1,
    heights = unit.c(unit(1, "npc") - lheight, lheight),
    widths = unit(0.5, "npc")
    
    )

}

```



Read in the functional data: 
```{r}
func<- read.csv('/projects/gherman/SPINS_human_phantoms/group_bold.tsv', sep='\t') %>%
  mutate(subj = substr(bids_name,1, 6), year = substr(bids_name, 8, 13), site=substr(bids_name, 14, 16), parent_site=substr(bids_name,14,15)) %>% mutate(scanner_type= ifelse(substr(bids_name,16,16)=="P", "prisma","GE")) %>% filter(subj!="sub-05")
```

Write func to a csv for colin
```{r}
func_output <- func %>% select(bids_name, scanner=site, parent_site, scanner_type, subj, year,  tsnr, snr, dvars_nstd, fd_mean, fd_perc)

write.csv(func_output, "../out/func_summary_july.csv")
```



```{r}
mriqc=func
metric="tsnr"


fillz=c(NA, "black",NA,"black",NA,"black")

names(fillz)= c("CMH", "CMP", "MRC" ,"MRP", "ZHH" ,"ZHP")


ggplot(data=mriqc, mapping = aes_string(x="subj", y=metric)) + geom_boxplot(outlier.shape=NA, width=0.8)+ geom_jitter(width=0.1, aes( fill=scanner_type, shape=parent_site))+theme_classic(base_size=6)+theme(panel.background = element_rect(fill="white", colour="white"),axis.title.x=element_blank()) +scale_shape_manual(values=c(21,23,24))+scale_fill_manual(values=c(NA,"black")) +guides(fill=guide_legend("title"), shape=guide_legend("title")) 


```



```{r}
mriqc=func
metric="tsnr"

#shapez=c(21,23,24,21,23,24)
shapez=c("\u26AA","\u2605","\u2662","\u26AB","\u2606","\u2666") #cool so this works but not when the types are mixed
#OKAY so im gonna use unicode yayeart
names(shapez)=c("CMH","MRP","ZHH","CMP","MRC","ZHP")



fillz=c(NA,"black",NA,"black",NA,"black")
names(fillz)=c("CMH","MRP","ZHH","CMP","MRC","ZHP")


ggplot(data=mriqc, mapping = aes_string(x="subj", y=metric)) + geom_jitter(width=0.1, size=6, aes( fill=site, shape=site))+theme_classic(base_size=12)+theme(panel.background = element_rect(fill="white", colour="white"),axis.title.x=element_blank()) +scale_shape_manual(values=shapez)+scale_fill_manual(values=fillz) +guides(fill=guide_legend("title"), shape=guide_legend("title"))


```



Plot some fmri metrics
```{r}

tsnr <- plot_mriqc_metric(func,"tsnr","tSNR")

dvars <- plot_mriqc_metric(func, "dvars_nstd","DVARS")

fd_mean <- plot_mriqc_metric(func,"fd_mean","Mean FD (mm)")

#cnr <- plot_mriqc_metric(func, "cnr")

#gsr <- plot_mriqc_metric("gsr")

#efc <- plot_mriqc_metric(func, "efc")

#aor <- plot_mriqc_metric(func, "aor")


plt <- grid_arrange_shared_legend(dvars, tsnr, fd_mean)

ggsave(file="../out/fmri_plots_july.tiff",plt, width =7, height=5)

plt

```


```{r}
ggsave(file="plotahijsfads_july.tiff",plt, width =7, height=5)

```



Read in the T1 data: 
```{r}
T1 <- read.csv('/projects/gherman/SPINS_human_phantoms/group_T1w.tsv', sep='\t') %>%
  mutate(subj = substr(bids_name,1, 6), year = substr(bids_name, 8, 13), site=substr(bids_name, 14, 16), parent_site=substr(bids_name,14,15))%>% mutate(scanner_type= ifelse(substr(bids_name,16,16)=="P", "prisma","GE")) %>% filter(subj!="sub-05")
```


```{r}
t1_output <- T1 %>% select(bids_name, scanner=site, parent_site, scanner_type, subj, year,  cnr, snr_csf,	snr_gm,	snr_total,	snr_wm,	snrd_csf,	snrd_gm,	snrd_total,	snrd_wm)

write.csv(t1_output, "../out/T1w_summary_july.csv")

```


```{r}

cnr <- plot_mriqc_metric(T1,"cnr", "CNR")

snr_total <- plot_mriqc_metric(T1, "snr_total", "SNR")

snrd_total <- plot_mriqc_metric(T1, "snrd_total", "SNRD(remove)")


#fwhm_avg <- plot_mriqc_metric(T1, "fwhm_avg")

#cjv <- plot_mriqc_metric(T1, "cjv")

#efc <- plot_mriqc_metric(T1, "efc")

plt <- grid_arrange_shared_legend(snrd_total,snr_total, cnr)

ggsave(file="../out/t1_plots_july.tiff",plt, width =7, height=5) #might have to fix it in illustrator after or something...

plt
```


Read in the T2 data: 
```{r}
#T2 <- read.csv('/projects/gherman/SPINS_human_phantoms/group_T2w.tsv', sep='\t')%>%
#  mutate(subj = substr(bids_name,1, 6), year = substr(bids_name, 8, 13), site=substr(bids_name, 14, 16), parent_site=substr(bids_name,14,15))%>% mutate(scanner_type= ifelse(substr(bids_name,16,16)=="P", "prisma","GE")) %>% filter(subj!="sub-05")
```


```{r}
t#2_output <- T2 %>% select(bids_name, scanner=site, parent_site, scanner_type, subj, year,  cnr, snr_csf,	snr_gm,	snr_total,	snr_wm,	snrd_csf,	snrd_gm,	snrd_total,	snrd_wm)

#write.csv(t2_output, "../out/T2w_summary_july.csv")
```


```{r}

cnr <- plot_mriqc_metric(T2,"cnr", "CNR")

snr_total <- plot_mriqc_metric(T2, "snr_total", "SNR")

#snrd_total <- plot_mriqc_metric(T2, "snrd_total")


#fwhm_avg <- plot_mriqc_metric(T2, "fwhm_avg")

#cjv <- plot_mriqc_metric(T2, "cjv")

#efc <- plot_mriqc_metric(T2, "efc")

grid_arrange_shared_legend(cnr, snr_total)


#So whether to use dietrich's SNR vs just SNR
```


ewwwwwwwwwww a very ugly histogram lol
```{r}
ggplot(data=func)+ geom_histogram(mapping=aes(x=snr ), stat="bin") # geom_bar(mapping=aes(x=snr, y=..prop.. , group=1))
```


Should run the DTI pipelines on the human phantom data once they become available and we decide on the kind of metrics to use.